<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="ca" xml:lang="ca" xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" type="text/css" href="base.css" />
<link rel="stylesheet" type="text/css" href="content.css" />
<link rel="stylesheet" type="text/css" href="nav.css" />
<meta http-equiv="content-type" content="text/html;  charset=utf-8" />
<title>4.2.2.6 - Exemple de consulta "elaborada" | Bases de Dades </title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<meta http-equiv="content-language" content="ca" />
<meta name="author" content="Àlvar Serrano Calduch" />
<meta name="generator" content="eXeLearning 2.6 - exelearning.net" />
<script type="text/javascript" src="exe_jquery.js"></script>
<script type="text/javascript" src="common_i18n.js"></script>
<script type="text/javascript" src="common.js"></script>
</head>
<body class="exe-web-site" id="exe-node-65"><script type="text/javascript">document.body.className+=" js"</script>
<div id="content">
<p id="skipNav"><a href="#main" class="sr-av">Omet navegació</a></p>
<div id="header" ><div id="headerContent">Bases de Dades</div></div>
<div id="siteNav">
<ul>
   <li><a href="index.html" class="daddy main-node">Tema 8: Bases de Dades NoSQL</a></li>
   <li><a href="1__introducci.html" class="no-ch">1 - Introducció</a></li>
   <li><a href="2__bd_clauvalor_redis.html" class="daddy">2 - BD Clau-Valor: Redis</a>
   <ul class="other-section">
      <li><a href="21__installaci_de_redis.html" class="no-ch">2.1 - Instal·lació de Redis</a></li>
      <li><a href="22__entron_grfic_redis_desktop_manager.html" class="no-ch">2.2 - Entron gràfic: Redis Desktop Manager</a></li>
      <li><a href="23__utilitzaci_de_redis.html" class="daddy">2.3 - Utilització de Redis</a>
      <ul class="other-section">
         <li><a href="231__strings.html" class="no-ch">2.3.1 - Strings</a></li>
         <li><a href="232__keys.html" class="no-ch">2.3.2 - Keys</a></li>
         <li><a href="233__hash.html" class="no-ch">2.3.3 - Hash</a></li>
         <li><a href="234__list.html" class="no-ch">2.3.4 - List</a></li>
         <li><a href="235__set.html" class="no-ch">2.3.5 - Set</a></li>
         <li><a href="236__set_ordenat.html" class="no-ch">2.3.6 - Set ordenat</a></li>
      </ul>
      </li>
   </ul>
   </li>
   <li><a href="3__mongodb.html" class="daddy">3 - MongoDB</a>
   <ul class="other-section">
      <li><a href="31__installaci_de_mongodb.html" class="daddy">3.1 - Instal·lació de MongoDB</a>
      <ul class="other-section">
         <li><a href="311__connexi_al_servidor_de_linstitut.html" class="no-ch">3.1.1 - Connexió al servidor de l'Institut</a></li>
      </ul>
      </li>
      <li><a href="32__utilitzaci_de_mongodb.html" class="daddy">3.2 - Utilització de MongoDB</a>
      <ul class="other-section">
         <li><a href="321__tipus_de_dades.html" class="no-ch">3.2.1 - Tipus de dades</a></li>
         <li><a href="322__operacions_bsiques.html" class="no-ch">3.2.2 - Operacions bàsiques</a></li>
         <li><a href="323__operacions_dactualitzaci_avanada.html" class="daddy">3.2.3 - Operacions d'actualització avançada</a>
         <ul class="other-section">
            <li><a href="3231__set.html" class="no-ch">3.2.3.1 - $set</a></li>
            <li><a href="3232__unset.html" class="no-ch">3.2.3.2 - $unset</a></li>
            <li><a href="3233__rename.html" class="no-ch">3.2.3.3 - $rename</a></li>
            <li><a href="3234__inc.html" class="no-ch">3.2.3.4 - $inc</a></li>
            <li><a href="3235__elements_dun_array.html" class="no-ch">3.2.3.5 - Elements d'un array</a></li>
            <li><a href="3236__inserci_en_arrays_push.html" class="no-ch">3.2.3.6 - Inserció en Arrays: $push</a></li>
            <li><a href="3237__eliminaci_en_arrays_pop_i_pull.html" class="no-ch">3.2.3.7 - Eliminació en arrays: $pop i $pull</a></li>
            <li><a href="3238__upsert.html" class="no-ch">3.2.3.8 - Upsert</a></li>
         </ul>
         </li>
      </ul>
      </li>
      <li><a href="33__consulta_de_documents.html" class="daddy">3.3 - Consulta de documents</a>
      <ul class="other-section">
         <li><a href="331__parmetres_de_les_funcions_find_i_findone.html" class="no-ch">3.3.1 - Paràmetres de les funcions find() i findOne()</a></li>
         <li><a href="332__operadors_de_les_condicions.html" class="no-ch">3.3.2 - Operadors de les condicions</a></li>
         <li><a href="333__agregaci.html" class="no-ch">3.3.3 - Agregació</a></li>
      </ul>
      </li>
   </ul>
   </li>
   <li class="current-page-parent"><a href="4__bd_xml_existdb.html" class="current-page-parent daddy">4 - BD XML: eXist-db</a>
   <ul>
      <li><a href="41__installaci_dexistdb.html" class="no-ch">4.1 - Instal·lació d'eXist-db</a></li>
      <li class="current-page-parent"><a href="42__llenguatges_de_consultes_xpath_i_xquery.html" class="current-page-parent daddy">4.2 - Llenguatges de consultes XPATH i XQUERY</a>
      <ul>
         <li><a href="421__xpath.html" class="daddy">4.2.1 - XPATH</a>
         <ul class="other-section">
            <li><a href="4211__vista_darbre.html" class="no-ch">4.2.1.1 - Vista d'arbre</a></li>
            <li><a href="4212__navegaci.html" class="no-ch">4.2.1.2 - Navegació</a></li>
            <li><a href="4213__seqncies.html" class="no-ch">4.2.1.3 - Seqüències</a></li>
            <li><a href="4214__funcions.html" class="no-ch">4.2.1.4 - Funcions</a></li>
         </ul>
         </li>
         <li class="current-page-parent"><a href="422__xquery.html" class="current-page-parent daddy">4.2.2 - XQUERY</a>
         <ul>
            <li><a href="4221__consultes_xquery.html" class="no-ch">4.2.2.1 - Consultes XQuery</a></li>
            <li><a href="4222__variables.html" class="no-ch">4.2.2.2 - Variables</a></li>
            <li><a href="4223__expressions_avaluables.html" class="no-ch">4.2.2.3 - Expressions avaluables</a></li>
            <li><a href="4224__expressions_flwor.html" class="no-ch">4.2.2.4 - Expressions FLWOR</a></li>
            <li><a href="4225__alternatives.html" class="no-ch">4.2.2.5 - Alternatives</a></li>
            <li id="active"><a href="4226__exemple_de_consulta_elaborada.html" class="active no-ch">4.2.2.6 - Exemple de consulta "elaborada"</a></li>
            <li><a href="4227__funcions_de_existdb_de_manipulaci_de_bd.html" class="no-ch">4.2.2.7 - Funcions de eXist-db de manipulació de BD</a></li>
         </ul>
         </li>
      </ul>
      </li>
   </ul>
   </li>
   <li><a href="exercicis.html" class="no-ch">Exercicis</a></li>
</ul>
</div>
<div id='topPagination'>
<div class="pagination noprt">
<a href="4225__alternatives.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="4227__funcions_de_existdb_de_manipulaci_de_bd.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
<div id="main-wrapper">
<div id="main"><a name="main"></a>
<div id="nodeDecoration"><h1 id="nodeTitle">4.2.2.6 - Exemple de consulta "elaborada"</h1></div>
<div class="iDevice_wrapper FreeTextIdevice" id="id263">
<div class="iDevice emphasis0">
<div id="ta263_1" class="block iDevice_content">
<p>Partint d’aquest XML d’exemple que representa comandes de llibres (guardeu-lo com un document anomenat <strong>comanda_llibres.xml</strong>):</p>
<div class="codi2">
<div>&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div>
<div>&lt;petició llibreria="Fantastica SL"&gt;</div>
<div style="margin-left: 30px;">&lt;data&gt;15-11-2011&lt;/data&gt;</div>
<div style="margin-left: 30px;">&lt;autor&gt;</div>
<div style="margin-left: 60px;">&lt;nom&gt;Frédérik McCloud&lt;/nom&gt;</div>
<div style="margin-left: 60px;">&lt;llibres&gt;</div>
<div style="margin-left: 90px;">&lt;llibre&gt;</div>
<div style="margin-left: 120px;">&lt;titol&gt;Les empentes&lt;/titol&gt;</div>
<div style="margin-left: 120px;">&lt;quantitat&gt;2&lt;/quantitat&gt;</div>
<div style="margin-left: 90px;">&lt;/llibre&gt;</div>
<div style="margin-left: 60px;">&lt;/llibres&gt;</div>
<div style="margin-left: 30px;">&lt;/autor&gt;</div>
<div style="margin-left: 30px;">&lt;autor&gt;</div>
<div style="margin-left: 60px;">&lt;nom&gt;Corsaro Levy&lt;/nom&gt;</div>
<div style="margin-left: 60px;">&lt;llibres&gt;</div>
<div style="margin-left: 90px;">&lt;llibre&gt;</div>
<div style="margin-left: 120px;">&lt;titol&gt;Marxant de la font del gat&lt;/titol&gt;</div>
<div style="margin-left: 120px;">&lt;quantitat&gt;2&lt;/quantitat&gt;</div>
<div style="margin-left: 90px;">&lt;/llibre&gt;</div>
<div style="margin-left: 90px;">&lt;llibre&gt;</div>
<div style="margin-left: 120px;">&lt;titol&gt;Bèstia!&lt;/titol&gt;</div>
<div style="margin-left: 120px;">&lt;quantitat&gt;2&lt;/quantitat&gt;</div>
<div style="margin-left: 90px;">&lt;/llibre&gt;</div>
<div style="margin-left: 60px;">&lt;/llibres&gt;</div>
<div style="margin-left: 30px;">&lt;/autor&gt;</div>
<div style="margin-left: 30px;">&lt;autor&gt;</div>
<div style="margin-left: 60px;">&lt;nom&gt;Marc Blairet&lt;/nom&gt;</div>
<div style="margin-left: 60px;">&lt;llibres&gt;</div>
<div style="margin-left: 90px;">&lt;llibre&gt;</div>
<div style="margin-left: 120px;">&lt;titol&gt;Tres de tres&lt;/titol&gt;</div>
<div style="margin-left: 120px;">&lt;quantitat&gt;3&lt;/quantitat&gt;</div>
<div style="margin-left: 90px;">&lt;/llibre&gt;</div>
<div style="margin-left: 60px;">&lt;/llibres&gt;</div>
<div style="margin-left: 30px;">&lt;/autor&gt;</div>
<div>&lt;/petició&gt;</div>
</div>
<p>Es vol respondre la pregunta següent: <strong>de quins autors s’han demanat tres o més llibres?</strong></p>
<p>Anem a fer l'exercici a poc a poc, de manera constructiva.</p>
<p>Per respondre aquesta pregunta el primer que cal és separar el document en blocs d’autor i processar-ne cada un de manera diferent. Per tant, es defineix un bucle amb un <strong><b>for</b></strong> per cada autor i s’escriu el nom per pantalla</p>
<div class="codi">
<div>for $autor in doc("/db/Tema9/comanda_llibres.xml")//autor</div>
<div>return $autor/nom</div>
</div>
<p>El resultat serà una llista de tots els autors:</p>
<div class="codi2">&lt;nom&gt;Frédérik McCloud&lt;/nom&gt;<br />
<div>&lt;nom&gt;Corsaro Levy&lt;/nom&gt;</div>
<div>&lt;nom&gt;Marc Blairet&lt;/nom&gt;</div>
</div>
<p>Es vol definir una restricció amb la quantitat de llibres que s’han demanat de cada autor; per tant, ho podríem intentar fer amb el <b>where</b></p>
<div class="codi">
<div>for $autor in doc("<span>/db/Tema9/comanda_</span>llibres.xml")//autor</div>
<div>where $autor/llibres/llibre/quantitat &gt;= 3</div>
<div>return $autor/nom</div>
</div>
<p>Aquesta és la llista dels autors que tenen alguna petició de 3 o més llibres</p>
<div class="codi2">
<div>&lt;nom&gt;Marc Blairet&lt;/nom&gt;</div>
</div>
<p>Però es pot veure que encara no és el demanat, ja que no apareix l’autor Corsaro Levy, del qual s’han demanat dues unitats llibres diferents. Per tant, agrupem les quantitats per obtenir el resultat correcte</p>
<div class="codi">
<div>for $autor in doc("<span>/db/Tema9/comanda_</span>llibres.xml")//autor</div>
<div>where sum($autor/llibres/llibre/quantitat) &gt;= 3</div>
<div>return $autor/nom</div>
</div>
<p>Ara el resultat sí que és el correcte:</p>
<div class="codi2">
<div>&lt;nom&gt;Corsaro Levy&lt;/nom&gt;</div>
<div>&lt;nom&gt;Marc Blairet&lt;/nom&gt;</div>
</div>
<p>Podem fer que el resultat siga més “bonic” mostrant les quantitats venudes al costat de cada autor i ordenant de més a menys els resultats.</p>
<div class="codi">
<div>for $autor in doc("<span>/db/Tema9/comanda_</span>llibres.xml")//autor </div>
<div>let $suma := sum($autor/llibres/llibre/quantitat)</div>
<div>where $suma &gt;=3</div>
<div>order by $suma descending</div>
<div>return concat($autor/nom," : ", $suma)</div>
</div>
<p>Es pot veure que per no haver d’escriure diverses vegades l’expressió de suma s’ha definit una variable <b>$suma</b> i d’aquesta manera l’expressió ha quedat més fàcil d’escriure</p>
<div class="codi2">
<div>"Corsaro Levy : 4"</div>
<div>"Marc Blairet : 3"</div>
</div>
<p>La funció <b>concat()</b> ha eliminat les etiquetes XML i ha generat un resultat de text. Si es vol mantenir una estructura XML es pot crear manualment amb l’ajuda de les expressions avaluables:</p>
<div class="codi">
<div>for $autor in doc("<span>/db/Tema9/comanda_</span>llibres.xml")//autor </div>
<div>let $suma := sum($autor/llibres/llibre/quantitat)</div>
<div>where $suma &gt;=3</div>
<div>order by $suma descending</div>
<div>return &lt;autor&gt; { concat($autor/nom," : ", $suma) } &lt;/autor&gt;</div>
</div>
<p>Que generarà:</p>
<div class="codi2">
<div>&lt;autor&gt;Corsaro Levy : 4&lt;/autor&gt;</div>
<div>&lt;autor&gt;Marc Blairet : 3&lt;/autor&gt;</div>
</div>
<p> </p>
</div>
</div>
</div>
<div id='bottomPagination'>
<div class="pagination noprt">
<a href="4225__alternatives.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="4227__funcions_de_existdb_de_manipulaci_de_bd.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
</div>
</div>
</div>
</body></html>