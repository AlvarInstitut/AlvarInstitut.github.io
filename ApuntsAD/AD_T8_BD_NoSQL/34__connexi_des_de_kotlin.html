<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="ca" xml:lang="ca" xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" type="text/css" href="base.css" />
<link rel="stylesheet" type="text/css" href="exe_highlighter.css" />
<link rel="stylesheet" type="text/css" href="content.css" />
<link rel="stylesheet" type="text/css" href="nav.css" />
<meta http-equiv="content-type" content="text/html;  charset=utf-8" />
<title>3.4 - Connexió des de Kotlin | Bases de Dades </title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<meta http-equiv="content-language" content="ca" />
<meta name="author" content="Àlvar Serrano Calduch" />
<link rel="license" type="text/html" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" />
<meta name="generator" content="eXeLearning 2.7 - exelearning.net" />
<script type="text/javascript" src="exe_jquery.js"></script>
<script type="text/javascript" src="exe_highlighter.js"></script>
<script type="text/javascript" src="common_i18n.js"></script>
<script type="text/javascript" src="common.js"></script>
</head>
<body class="exe-web-site" id="exe-node-35"><script type="text/javascript">document.body.className+=" js"</script>
<div id="content">
<p id="skipNav"><a href="#main" class="sr-av">Omet navegació</a></p>
<div id="header" ><div id="headerContent">Bases de Dades</div></div>
<div id="siteNav">
<ul>
   <li><a href="index.html" class="daddy main-node">Tema 8: Bases de Dades NoSQL</a></li>
   <li><a href="1__introducci.html" class="no-ch">1 - Introducció</a></li>
   <li><a href="2__bases_de_dades_clauvalor.html" class="daddy">2 - Bases de Dades Clau-Valor</a>
   <ul class="other-section">
      <li><a href="21__installaci_de_redis.html" class="no-ch">2.1 - Instal·lació de Redis</a></li>
      <li><a href="22__utilitzaci_de_redis.html" class="daddy">2.2 - Utilització de Redis</a>
      <ul class="other-section">
         <li><a href="221__strings.html" class="no-ch">2.2.1 - Strings</a></li>
         <li><a href="222__keys.html" class="no-ch">2.2.2 - Keys</a></li>
         <li><a href="223__hash.html" class="no-ch">2.2.3 - Hash</a></li>
         <li><a href="224__list.html" class="no-ch">2.2.4 - List</a></li>
         <li><a href="225__set.html" class="no-ch">2.2.5 - Set</a></li>
         <li><a href="226__set_ordenat.html" class="no-ch">2.2.6 - Set ordenat</a></li>
      </ul>
      </li>
      <li><a href="23__connexi_des_de_kotlin.html" class="no-ch">2.3 - Connexió des de Kotlin</a></li>
   </ul>
   </li>
   <li class="current-page-parent"><a href="3__mongodb.html" class="current-page-parent daddy">3 - MongoDB</a>
   <ul>
      <li><a href="31__installaci_de_mongodb.html" class="daddy">3.1 - Instal·lació de MongoDB</a>
      <ul class="other-section">
         <li><a href="311__connexi_al_servidor_de_linstitut.html" class="no-ch">3.1.1 - Connexió al servidor de l'Institut</a></li>
      </ul>
      </li>
      <li><a href="32__utilitzaci_de_mongodb.html" class="daddy">3.2 - Utilització de MongoDB</a>
      <ul class="other-section">
         <li><a href="321__tipus_de_dades.html" class="no-ch">3.2.1 - Tipus de dades</a></li>
         <li><a href="322__operacions_bsiques.html" class="no-ch">3.2.2 - Operacions bàsiques</a></li>
         <li><a href="323__operacions_dactualitzaci_avanada.html" class="daddy">3.2.3 - Operacions d'actualització avançada</a>
         <ul class="other-section">
            <li><a href="3231__set.html" class="no-ch">3.2.3.1 - $set</a></li>
            <li><a href="3232__unset.html" class="no-ch">3.2.3.2 - $unset</a></li>
            <li><a href="3233__rename.html" class="no-ch">3.2.3.3 - $rename</a></li>
            <li><a href="3234__inc.html" class="no-ch">3.2.3.4 - $inc</a></li>
            <li><a href="3235__elements_dun_array.html" class="no-ch">3.2.3.5 - Elements d'un array</a></li>
            <li><a href="3236__inserci_en_arrays_push.html" class="no-ch">3.2.3.6 - Inserció en Arrays: $push</a></li>
            <li><a href="3237__eliminaci_en_arrays_pop_i_pull.html" class="no-ch">3.2.3.7 - Eliminació en arrays: $pop i $pull</a></li>
            <li><a href="3238__upsert.html" class="no-ch">3.2.3.8 - Upsert</a></li>
         </ul>
         </li>
      </ul>
      </li>
      <li><a href="33__consulta_de_documents.html" class="daddy">3.3 - Consulta de documents</a>
      <ul class="other-section">
         <li><a href="331__parmetres_de_les_funcions_find_i_findone.html" class="no-ch">3.3.1 - Paràmetres de les funcions find() i findOne()</a></li>
         <li><a href="332__operadors_de_les_condicions.html" class="no-ch">3.3.2 - Operadors de les condicions</a></li>
         <li><a href="333__agregaci.html" class="no-ch">3.3.3 - Agregació</a></li>
      </ul>
      </li>
      <li id="active"><a href="34__connexi_des_de_kotlin.html" class="active no-ch">3.4 - Connexió des de Kotlin</a></li>
      <li><a href="35__connexi_des_de_kotlin_al_servidor_de_linstitut.html" class="no-ch">3.5 - Connexió des de Kotlin al servidor de l'Institut</a></li>
   </ul>
   </li>
   <li><a href="exercicis.html" class="no-ch">Exercicis</a></li>
</ul>
</div>
<div id='topPagination'>
<div class="pagination noprt">
<a href="333__agregaci.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="35__connexi_des_de_kotlin_al_servidor_de_linstitut.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
<div id="main-wrapper">
<div id="main"><a name="main"></a>
<div id="nodeDecoration"><h1 id="nodeTitle">3.4 - Connexió des de Kotlin</h1></div>
<div class="iDevice_wrapper FreeTextIdevice" id="id145">
<div class="iDevice emphasis0">
<div id="ta145_85" class="block iDevice_content">

</div>
</div>
</div>
<div class="iDevice_wrapper FreeTextIdevice" id="id146">
<div class="iDevice emphasis0">
<div id="ta146_85" class="block iDevice_content">
<p>Per a poder connectar des de Java o Kotlin ens sera suficient amb un driver, que haurem d'incorporar al projecte. En la següent pàgina podem trobar-lo, en diferents versions:</p>
<p><a href="https://repo1.maven.org/maven2/org/mongodb/mongo-java-driver/">https://repo1.maven.org/maven2/org/mongodb/mongo-java-driver/</a></p>
<p>En el moment de fer aquestos apunts, l'últim driver disponible és el següent:</p>
<p><a href="https://repo1.maven.org/maven2/org/mongodb/mongo-java-driver/3.9.1/mongo-java-driver-3.9.1.jar">https://repo1.maven.org/maven2/org/mongodb/mongo-java-driver/3.9.1/mongo-java-driver-3.9.1.jar</a></p>
<p>Per a separar les proves i exercicis de la part de <strong>Redis</strong>, creem un nou projecte anomenat <strong>Tema8_2</strong> , en un paquet anomenat <strong>Exemples</strong>.</p>
<p class="titolet">Connexió</p>
<p>La connexió és tan senzilla com el següent:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>   val con = MongoClient("localhost", 27017)
   val bd = con.getDatabase("test")
</code></pre>
</div>
</div>
<p>És a dir, obtenim un objecte <strong>MongoClient</strong> passant-li al constructor l'adreça del servidor i el port de connexió (que per defecte és 27017).</p>
<p>Posteriorment hem de connectar amb la Base de Dades. Ja havíem comentat en la instal·lació de Mongo que nosaltres només utilitzaríem una Base de Dades ja creada anomenada <strong>test</strong>. Obtenim un objecte <strong>MongoDatabase </strong>que farà referència a la Base de Dades, i és l'objecte que utilitzarem a partir d'ara. Evidentment ho podríem haver fet en una única línia.</p>
<p>Si el servidor no el tenim en la mateixa màquina, només haurem de substituir <strong>localhost</strong> per l'adreça on estiga el servidor.</p>
<p>Per a tancar la connexió:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>   con.close()</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="iDevice_wrapper FreeTextIdevice" id="id147">
<div class="iDevice emphasis0">
<div id="ta147_85" class="block iDevice_content">
<p class="titolet">Inserció de documents</p>
<p>Des de Kotlin podrem inserir documents amb la mateixa facilitat que des de la consola. Només haurem de crear un objecte <strong>Document </strong> de <strong>BSON</strong> (recordeu que és el format intern de Mongo, absolutament similar a <strong>JSON</strong>). La manera d'anar posant parelles calu valor en aquest document és per mig del mètode <strong>put</strong>. Fem un exemple molt senzill on senzillament guardem un document amb una parella clau-valor d'un missatge. Guardeu-lo amb el nom <strong>Prova1.kt</strong>:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>import com.mongodb.MongoClient
import org.bson.Document

fun main(args: Array&lt;String&gt;) {
    val con = MongoClient("localhost", 27017)
    val bd = con.getDatabase("test")
    val doc = Document()
    doc.put("msg4", "Missatge inserit des de Kotlin")
    bd.getCollection("exemple").insertOne(doc)
    con.close()
}</code></pre>
</div>
</div>
<p>Segurament traurà avisos en la consola, però només són avisos. Podem comprovar en la terminal com s'ha inserit el document:</p>
<p style="text-align: center;"><img src="T8_3_4_1.png" /></p>
<p></p>
<p></p>
</div>
</div>
</div>
<div class="iDevice_wrapper FreeTextIdevice" id="id148">
<div class="iDevice emphasis0">
<div id="ta148_85" class="block iDevice_content">
<p class="titolet">Consultes</p>
<p>Tenim el mètode <strong>find()</strong> per a fer consultes, i li podem posar un document com a paràmetre per a seleccionar determinats documents o traure determinada informació. Guardeu el següent exemple amb el nom <strong>Prova2.kt</strong>:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>import com.mongodb.MongoClient

fun main(){
    val con = MongoClient("localhost" , 27017)
    val bd = con.getDatabase("test")
   val llibres = bd.getCollection("libro").find()

    for (llibre in llibres)
        println(llibre.get("titulo"))

   con.close();
}</code></pre>
</div>
</div>
<p>I com comentàvem podem posar com a paràmetres en el find() per a seleccionar determinats documents, ordenar, etc. Només hem de cuidar que ho hem de posar en <strong>JSON </strong>(millor dit <strong>BSON</strong>), i per tant haurem de crear un document per a això. Copieu el següent exemple amb el nom <strong>Prova3.kt</strong>:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>import com.mongodb.MongoClient
import org.bson.Document

fun main(){
    val con = MongoClient("localhost", 27017)
    val bd = con.getDatabase("test")

    val ordenar = Document()
    ordenar.put("precio", -1)

    val llibres = bd.getCollection("libro").find().sort(ordenar)

    for (llibre in llibres) System.out.println(
        "Títol: " + llibre.get("titulo").toString() + ". Preu: " + llibre.get("precio")
    )

    con.close()
}</code></pre>
</div>
</div>
<p>El resultat serà aquest:</p>
<p style="text-align: center;"><img src="T8_3_4_2.png" alt="" width="1256" height="429" /></p>
<p>Hem pogut observar en l'execució dels exemples anteriors que ens trau una gran quantitat d'avisos. No són errors, sinó senzillament informació de com van les connexions, que mongo torna, i apareixen en l'eixida estàndar.</p>
<p>Si no volem que apareguen podem posar al principi del programa una sentència per a dir que únicament apareguen els errors, i no els avisos. Els errors estarien en la categoria de <strong>SEVERE</strong></p>
<div class="highlighted-code language-java">
<div>
<pre><code>    LogManager.getLogManager().getLogger("").setLevel(Level.SEVERE)
</code></pre>
</div>
</div>
<p>Hem d'importar les classes de <strong>java.util</strong>. Quedaria el mateix exemple <strong>Prova3.kt </strong>d'aquesta manera:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>import com.mongodb.MongoClient
import org.bson.Document
import java.util.logging.Level
import java.util.logging.LogManager

fun main(){
    LogManager.getLogManager().getLogger("").setLevel(Level.SEVERE)
    val con = MongoClient("localhost", 27017)
    val bd = con.getDatabase("test")

    val ordenar = Document()
    ordenar.put("precio", -1)

    val llibres = bd.getCollection("libro").find().sort(ordenar)

    for (llibre in llibres) System.out.println(
        "Títol: " + llibre.get("titulo").toString() + ". Preu: " + llibre.get("precio")
    )

    con.close()
}</code></pre>
</div>
</div>
<p>I el resultat ara serà:</p>
<p><img src="T8_3_4_3.png" alt="" style="display: block; margin-left: auto; margin-right: auto;" width="514" height="159" /></p>
</div>
</div>
</div>
<div class="iDevice_wrapper textIdevice" id="id230">
<div class="iDevice emphasis0" >
<div id="ta230_230_2" class="block iDevice_content">
<div class="exe-text"><p class="titolet">Agregació</p>
<p>Per a poder utilitzar la funció d'agregació, que té tanta potència, ens ho hem de muntar d'aquesta manera:</p>
<ul>
<li>Sobre la col·lecció utilitzar el mètode <strong>aggregate()</strong></li>
<li>Com a paràmetres, afegirem un <strong>MutableList</strong>. Cada element d'ell serà una opció d'aggregate</li>
<li>Per a cada opció ($match, $project...), utilitzarem el mètode d'<strong> Aggregates </strong>(una classe del driver de Mongo) amb el mateix nom:
<ul>
<li>Per a <strong>$match</strong>: <strong>Aggregates.match()</strong></li>
<li>Per a <strong>$project: Aggregates.project()</strong></li>
<li>...</li>
</ul>
</li>
<li>Dins de cadascun d'aquestos mètodes posarem un document BSon amb les especificacions que necessitem</li>
</ul>
<p>En aquest exemple farem la selecció (match) dels llibres de l'editorial Planeta, agafant (project) únicament el títol i l'editorial.</p>
<p>La sentència en la consola la faríem així:</p>
<p class="codi2">&gt; db.libro.aggregate({$match:{editorial:"Planeta"}},{$project:{titulo:1, editorial:1}})<br />{ "_id" : "9788408117117", "titulo" : "Circo Máximo", "editorial" : "Planeta" }<br />{ "_id" : "9788408113331", "titulo" : "Las carreras de Escorpio", "editorial" : "Planeta" }</p>
<p>El programa ens quedaria així. Guardeu-lo en en fitxer Kotlin anomenat <strong>Prova_Aggregate_1.kt</strong>:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>import com.mongodb.MongoClient
import com.mongodb.client.model.Aggregates
import org.bson.Document
import java.util.logging.Level
import java.util.logging.LogManager

fun main(){
    LogManager.getLogManager().getLogger("").setLevel(Level.SEVERE)
    val con = MongoClient("localhost", 27017)
    val bd = con.getDatabase("test")

    val seleccionar = Document()
    seleccionar.put("editorial", "Planeta")

    val projeccio = Document()
    projeccio.put("titulo",1)
    projeccio.put("editorial",1)

    val llibres = bd.getCollection("libro").aggregate(mutableListOf(Aggregates.match(seleccionar),Aggregates.project(projeccio)))

    for (llibre in llibres)
        println("Títol: " + llibre.get("titulo").toString() + ".   Editorial: " + llibre.get("editorial").toString()
    )

    con.close()
}</code></pre>
</div>
</div>
<p>Mirem un altre exemple. Traure el llibre més barat de cada any.</p>
<p>La consulta en Mongo que faríem en la consola de Mongo seria:</p>
<p class="codi2">&gt; db.libro.aggregate(<br />    {$group : { <br />       "_id" : { "any" : { $year : "$fecha" } } , <br />       "minim":{$min: "$precio"}}<br />    }, <br />    {$sort:{"_id":1}} <br /> )<br />{ "_id" : { "any" : 2009 }, "minim" : 9.45 }<br />{ "_id" : { "any" : 2011 }, "minim" : 9.5 }<br />{ "_id" : { "any" : 2012 }, "minim" : 11 }<br />{ "_id" : { "any" : 2013 }, "minim" : 17.23 }<br />{ "_id" : { "any" : 2014 }, "minim" : 15.9 }</p>
<p></p>
<p>Ara col·locarem aquesta sentència en un programa Kotlin. Guardeu el següent codi com el fitxer Kotlin <strong>Prova_Aggregate_2.kt</strong>:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>import com.mongodb.MongoClient
import com.mongodb.client.model.Aggregates
import org.bson.Document
import java.util.logging.Level
import java.util.logging.LogManager

fun main(){
    LogManager.getLogManager().getLogger("").setLevel(Level.SEVERE)
    val con = MongoClient("localhost", 27017)
    val bd = con.getDatabase("test")

    val grup = Document()
    grup.put("_id", Document("any",Document("\$year","\$fecha")))
    grup.put("minim",Document("\$min","\$precio"))

    val ordenar = Document()
    ordenar.put("_id",1)

    val llibres = bd.getCollection("libro").aggregate(mutableListOf(Aggregates.group(grup),Aggregates.sort(ordenar)))

    for (llibre in llibres){
        val d = llibre.get("_id") as Document
        println("Any: " + (d.get("_id") as Document).getInteger("any")+ ".   Mínim: " + d.getDouble("minim"))
    }

    con.close()
}</code></pre>
</div>
</div>
<p>Hem tingut la complicació que el resultat és més complicat, té un document dins d'una altre document (com es veu en el resultat de la sentència executada en la consola). Aquest serà el resultat:</p>
<p><img src="T8_3_4_1.1.png" alt="" style="display: block; margin-left: auto; margin-right: auto;" width="451" height="221" /></p></div>
</div>
</div>
</div>
<div id='bottomPagination'>
<div class="pagination noprt">
<a href="333__agregaci.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="35__connexi_des_de_kotlin_al_servidor_de_linstitut.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
<div id="packageLicense" class="cc cc-by-nc-nd">
<p><span>Llicenciat sota la </span> <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Llicència Creative Commons Reconeixement NoComercial SenseObraDerivada 4.0</a></p>
</div>
</div>
</div>
</div>
</body></html>