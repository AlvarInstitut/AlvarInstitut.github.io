<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="ca" xml:lang="ca" xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" type="text/css" href="base.css" />
<link rel="stylesheet" type="text/css" href="exe_highlighter.css" />
<link rel="stylesheet" type="text/css" href="content.css" />
<link rel="stylesheet" type="text/css" href="nav.css" />
<meta http-equiv="content-type" content="text/html;  charset=utf-8" />
<title>4.2.4 CF-IntelliJ: Exemple ampliat | Bases de Dades </title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<meta http-equiv="content-language" content="ca" />
<meta name="author" content="Àlvar Serrano Calduch" />
<meta name="generator" content="eXeLearning 2.6 - exelearning.net" />
<script type="text/javascript" src="exe_jquery.js"></script>
<script type="text/javascript" src="exe_highlighter.js"></script>
<script type="text/javascript" src="common_i18n.js"></script>
<script type="text/javascript" src="common.js"></script>
</head>
<body class="exe-web-site" id="exe-node-61"><script type="text/javascript">document.body.className+=" js"</script>
<div id="content">
<p id="skipNav"><a href="#main" class="sr-av">Omet navegació</a></p>
<div id="header" ><div id="headerContent">Bases de Dades</div></div>
<div id="siteNav">
<ul>
   <li><a href="index.html" class="daddy main-node">Tema 7: FIREBASE</a></li>
   <li><a href="1__introducci_firebase.html" class="no-ch">1 - Introducció: Firebase</a></li>
   <li><a href="2__creaci_duna_aplicaci.html" class="no-ch">2 - Creació d'una aplicació</a></li>
   <li><a href="3__realtime_database_rd.html" class="daddy">3 - Realtime Database (RD)</a>
   <ul class="other-section">
      <li><a href="31_rd_utilitzaci_des_de_lentorn_de_firebase.html" class="no-ch">3.1 RD: Utilització des de l'entorn de Firebase</a></li>
      <li><a href="32_rd_utilitzaci_des_de_intellij.html" class="daddy">3.2 RD: Utilització des de IntelliJ</a>
      <ul class="other-section">
         <li><a href="321_rdintellij_connexi_des_de_kotlin.html" class="no-ch">3.2.1 RD-IntelliJ: Connexió des de Kotlin</a></li>
         <li><a href="322_rdintellij_accs_a_les_dades.html" class="no-ch">3.2.2 RD-IntelliJ: Accés a les dades</a></li>
         <li><a href="323_rdintellij_tot_lexemple.html" class="no-ch">3.2.3 RD-IntelliJ: Tot l'exemple</a></li>
      </ul>
      </li>
      <li><a href="33_rd_utilitzaci_des_dandroid.html" class="daddy">3.3 RD: Utilització des d'Android</a>
      <ul class="other-section">
         <li><a href="331_rdandroid_connexi_des_dandroid.html" class="no-ch">3.3.1 RD-Android: Connexió des d'Android</a></li>
         <li><a href="332_rdandroid_accs_a_les_dades.html" class="no-ch">3.3.2 RD-Android: Accés a les dades</a></li>
         <li><a href="333_rdandroid_tot_lexemple.html" class="no-ch">3.3.3 RD-Android: Tot l'exemple</a></li>
      </ul>
      </li>
   </ul>
   </li>
   <li class="current-page-parent"><a href="4__cloud_firestore_cf.html" class="current-page-parent daddy">4 - Cloud Firestore (CF)</a>
   <ul>
      <li><a href="41_cf_utilitzaci_des_de_lentorn_de_firebase.html" class="no-ch">4.1 CF: Utilització des de l'entorn de Firebase</a></li>
      <li class="current-page-parent"><a href="42_cf_utilitzaci_des_de_intellij.html" class="current-page-parent daddy">4.2 CF: Utilització des de IntelliJ</a>
      <ul>
         <li><a href="421_cfintellij_connexi_des_de_kotlin.html" class="no-ch">4.2.1 CF-IntelliJ: Connexió des de Kotlin</a></li>
         <li><a href="422_cfintellij_accs_a_les_dades.html" class="no-ch">4.2.2 CF-IntelliJ: Accés a les dades</a></li>
         <li><a href="423_cfintellij_tot_lexemple.html" class="no-ch">4.2.3 CF-IntelliJ: Tot l'exemple</a></li>
         <li id="active"><a href="424_cfintellij_exemple_ampliat.html" class="active no-ch">4.2.4 CF-IntelliJ: Exemple ampliat</a></li>
      </ul>
      </li>
      <li><a href="43_cf_utilitzaci_des_dandroid.html" class="daddy">4.3 CF: Utilització des d'Android</a>
      <ul class="other-section">
         <li><a href="431_cfandroid_connexi.html" class="no-ch">4.3.1 CF-Android: Connexió</a></li>
         <li><a href="432_cfandroid_accs_a_les_dades.html" class="no-ch">4.3.2 CF-Android: Accés a les dades</a></li>
         <li><a href="433_cfandroid_tot_lexemple.html" class="no-ch">4.3.3 CF-Android: Tot l'exemple</a></li>
      </ul>
      </li>
   </ul>
   </li>
   <li><a href="5__cloud_storage.html" class="daddy">5 - Cloud Storage</a>
   <ul class="other-section">
      <li><a href="51_cs_utilitzaci_des_de_lentorn.html" class="no-ch">5.1 CS: Utilització des de l'entorn</a></li>
      <li><a href="52_cs_utilitzaci_des_de_intellij.html" class="daddy">5.2 CS: Utilització des de IntelliJ</a>
      <ul class="other-section">
         <li><a href="521_csintellij_connexi.html" class="no-ch">5.2.1 CS-IntelliJ: Connexió</a></li>
         <li><a href="522_csintellij_accs_a_les_dades.html" class="no-ch">5.2.2 CS-IntelliJ: Accés a les dades</a></li>
         <li><a href="523_csintellij_tot_lexemple.html" class="no-ch">5.2.3 CS-IntelliJ: Tot l'exemple</a></li>
         <li><a href="524_csintellij_exemple_ampliat_combinant_amb_cloud_firestore.html" class="no-ch">5.2.4 CS-IntelliJ: Exemple ampliat, combinant amb Cloud Firestore</a></li>
      </ul>
      </li>
      <li><a href="53_cs_utilitzaci_des_dandroid.html" class="daddy">5.3 CS: Utilització des d'Android</a>
      <ul class="other-section">
         <li><a href="531_csandroid_connexi.html" class="no-ch">5.3.1 CS-Android: Connexió</a></li>
         <li><a href="532_csandroid_accs_als_fitxers.html" class="no-ch">5.3.2 CS-Android: Accés als fitxers</a></li>
         <li><a href="533_csandroid_tot_lexemple.html" class="no-ch">5.3.3 CS-Android: Tot l'exemple</a></li>
         <li><a href="534_csandroid_exemple_ampliat_combinant_amb_cloud_firestore.html" class="no-ch">5.3.4 CS-Android: Exemple ampliat, combinant amb Cloud Firestore</a></li>
      </ul>
      </li>
   </ul>
   </li>
   <li><a href="exercicis.html" class="no-ch">Exercicis</a></li>
</ul>
</div>
<div id='topPagination'>
<div class="pagination noprt">
<a href="423_cfintellij_tot_lexemple.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="43_cf_utilitzaci_des_dandroid.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
<div id="main-wrapper">
<div id="main"><a name="main"></a>
<div id="nodeDecoration"><h1 id="nodeTitle">4.2.4 CF-IntelliJ: Exemple ampliat</h1></div>
<div class="iDevice_wrapper textIdevice" id="id198">
<div class="iDevice emphasis0" >
<div id="ta198_209_2" class="block iDevice_content">
<div class="exe-text"><p style="text-align: justify;">Anem a ampliar l'exemple anterior, fent algunes modificacions i millores:</p>
<ul style="text-align: justify;">
<li>Tindrem la classe <strong>Missatge</strong> amb les propietat <strong>nom</strong> i <strong>contingut</strong> (expressament diferents dels noms utilitzats en l'exemple anterior per poder comprovar que aquestes modificacions funcionen i milloren l'exemple). Posarem també la <strong>data</strong> (com un <strong>timestamp</strong> de Firebase que es correspon amb un <strong>Date</strong> de Java i Kotlin) per a poder ordenar els missatges cronològicament</li>
<li>Llevem les coses que no s'utilitzen estrictament en aquest exemple</li>
<li>No definirem la referència a la Base de Dades en cada utilització. Únicament una vegada al principi, després de la connexió.</li>
<li>Posem un <strong>JComboBox</strong> per a poder triar entre més d'un xat. Per a no modificar les coses ja fetes, posarem la creació dels listeners en un mètode anomenat <strong>inicialitzar()</strong>, ja que ara els listeners dependran del xat triat. I haurem d'anar amb compte també de parar els listeners, ja creats. És a dir, si primer triem un xat, tindrem els listeners que apunten a ell. Si després triem un altre xat i creem els listeners una altra vegada per a que apunten al lloc correcte, els tindrem per duplicat. Hauríem de parar els primers listeners</li>
</ul>
<p style="text-align: justify;"></p>
<p style="text-align: justify;">Aquesta és la classe <strong>Missatge</strong></p>
<div class="highlighted-code language-java">
<div>
<pre><code>class Missatge(var nom: String, var data: Date, var contingut: String)</code></pre>
</div>
</div>
<p>Aquest és el programa. Per comoditat hem posat la classe <strong>Missatge </strong>dins. Si l'heu definida en un fitxer independent, haureu d'esborrar la definició en aquest programa. Guardeu-lo amb el nom <strong>Exemple_7_4_2</strong><strong>_FirebaseCF_XatCloud_Millorat.kt</strong>:</p>
<div class="highlighted-code language-java">
<div>
<pre><code>import java.awt.EventQueue
import javax.swing.JFrame
import javax.swing.JLabel
import javax.swing.JTextArea
import javax.swing.JButton
import javax.swing.JTextField
import javax.swing.JPanel
import javax.swing.JComboBox
import java.awt.BorderLayout
import java.awt.FlowLayout
import java.awt.GridLayout
import java.awt.Color
import javax.swing.JScrollPane
import java.io.FileInputStream

import com.google.api.core.ApiFuture
import com.google.auth.oauth2.GoogleCredentials
import com.google.cloud.firestore.DocumentChange
import com.google.cloud.firestore.DocumentReference
import com.google.cloud.firestore.DocumentSnapshot
import com.google.cloud.firestore.EventListener
import com.google.cloud.firestore.Firestore
import com.google.cloud.firestore.FirestoreException
import com.google.firebase.FirebaseApp
import com.google.firebase.FirebaseOptions
import com.google.firebase.cloud.FirestoreClient
import com.google.cloud.firestore.ListenerRegistration
import java.text.SimpleDateFormat
import java.util.Date

class Missatge(var nom: String, var data: Date, var contingut: String)

class XatCloudMillorat : JFrame() {

	val etComboXats = JLabel("Llista de tots els xats disponibles:")
	val comboXats = JComboBox&lt;String&gt;()

	val etUsuari = JLabel("Nom Usuari:")
	val usuari = JTextField(25)

	val etUltimMissatge = JLabel("Últim missatge: ")
	val ultimMissatge = JLabel()

	val etiqueta = JLabel("Missatges:")
	val area = JTextArea()

	val etIntroduccioMissatge = JLabel("Introdueix missatge:")
	val enviar = JButton("Enviar")
	val missatge = JTextField(15)

	var database: Firestore? = null
	var docRef: DocumentReference? = null

	var listenerUltimMissatge: ListenerRegistration? = null
	var listenerMissatges: ListenerRegistration? = null

	// en iniciar posem un contenidor per als elements anteriors
	init {
		defaultCloseOperation = JFrame.EXIT_ON_CLOSE
		setBounds(100, 100, 550, 400)
		setLayout(BorderLayout())
		// contenidor per als elements
		//Hi haurà títol. Panell de dalt: últim missatge. Panell de baix: per a introduir missatge. Panell central: tot el xat

		val panell10 = JPanel(FlowLayout())
		panell10.add(etComboXats)
		panell10.add(comboXats)
		val panell11 = JPanel(FlowLayout())
		panell11.add(etUsuari)
		panell11.add(usuari)
		val panell12 = JPanel(FlowLayout())
		panell12.add(etUltimMissatge)
		panell12.add(ultimMissatge)
		val panell1 = JPanel(GridLayout(3, 1))
		panell1.add(panell10)
		panell1.add(panell11)
		panell1.add(panell12)
		getContentPane().add(panell1, BorderLayout.NORTH)

		val panell2 = JPanel(BorderLayout())
		panell2.add(etiqueta, BorderLayout.NORTH)
		area.setForeground(Color.blue)
		area.setEditable(false)
		val scroll = JScrollPane(area)
		panell2.add(scroll, BorderLayout.CENTER)
		getContentPane().add(panell2, BorderLayout.CENTER)

		val panell3 = JPanel(FlowLayout())
		panell3.add(etIntroduccioMissatge)
		panell3.add(missatge)
		panell3.add(enviar)
		getContentPane().add(panell3, BorderLayout.SOUTH)

		setVisible(true)
		comboXats.addActionListener() { inicialitzarXat() }
		enviar.addActionListener { enviar() }

		val serviceAccount = FileInputStream("acces-a-dades-6e5a6-firebase-adminsdk-ei7uc-fcf7da56aa.json")

		val options = FirebaseOptions.Builder()
			.setCredentials(GoogleCredentials.fromStream(serviceAccount))
			.build()

		FirebaseApp.initializeApp(options)

		database = FirestoreClient.getFirestore()


		// Exemple de llegir tots els documents d'una col·lecció
		// Per a triar el xat
		val documents = database?.collection("Xats")?.get()?.get()?.getDocuments()
		for (document in documents!!) {
			comboXats.addItem(document.getId())
		}
		comboXats.setSelectedIndex(0)

	}

	fun inicialitzarXat() {
		docRef = database?.collection("Xats")?.document(comboXats.getSelectedItem().toString())
		area.setText("")

		// Exemple de lectura única: senzillament sobre un ApiFuture i sobre ell get()
		// Per a posar el títol. Sobre /Xats/XatProva/nomXat
		val future = docRef?.get()
		val nomXat = future?.get()?.getString("nomXat")
		this.setTitle(nomXat)

		// Exemple de listener de lectura contínua addSnapshotListener()
		// Per a posar l'últim missatge registrat. Sobre /Xats/XatProva/ultimUsuari i /Xats/XatProva/ultimMissatge
		// Si estava en marxa, el parem abans de tornar-lo a llançar
		if (listenerUltimMissatge != null)
			listenerUltimMissatge!!.remove()

		listenerUltimMissatge = docRef?.addSnapshotListener { snapshot, e -&gt;
			ultimMissatge.setText(snapshot?.getString("ultimMissatge"))
		}

		// Exemple de listener de lectura contínua addSnapshotListener() sobre una col·lecció
		// Per a posar tota la llista de missatges. Sobre /Xats/XatProva/missatges
		// Si estava en marxa, el parem abans de tornar-lo a llançar
		if (listenerMissatges != null)
			listenerMissatges!!.remove()

		listenerMissatges = docRef?.collection("missatges")?.orderBy("data")?.addSnapshotListener { snapshots, e -&gt;
			for (dc in snapshots!!.getDocumentChanges()) {
				val dData = dc.getDocument().getDate("data")
				val d = SimpleDateFormat("dd-MM-yyyy HH:mm").format(dData)
				area.append(
					dc.getDocument().getString("nom") + " (" + d + "): " + dc.getDocument().getString("contingut") + "\n"
				)
			}
		}
	}


	// Exemple de guardar dades en Cloud Firestore
	// Per a guardar dades. Sobre /Xats/XatProva i després sobre /Xats/Xat1
	fun enviar() {
		val database = FirestoreClient.getFirestore()
		val docXat = database.collection("Xats").document(comboXats.getSelectedItem().toString())

		val dades = HashMap&lt;String, Any&gt;()
		dades.put("ultimUsuari", usuari.getText())
		dades.put("ultimMissatge", missatge.getText())

		docXat.update(dades)

		val dades2 = HashMap&lt;String, Any&gt;()
		dades2.put("nom", usuari.getText())
		dades2.put("contingut", missatge.getText())

		val m = Missatge(usuari.getText(), Date(), missatge.getText())
		docXat.collection("missatges").add(m)
	}

}

fun main(args: Array&lt;String&gt;) {
	EventQueue.invokeLater {
		XatCloudMillorat().isVisible = true
	}
}</code></pre>
</div>
</div>
<p><code> </code></p>
<p>I aquest és un exemple d'utilització. Es pot veure el JComboBox per a triar els diferents xats</p>
<p style="text-align: center;"><img src="T7_4_2_4_1.png" alt="" width="550" height="400" /></p></div>
</div>
</div>
</div>
<div id='bottomPagination'>
<div class="pagination noprt">
<a href="423_cfintellij_tot_lexemple.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="43_cf_utilitzaci_des_dandroid.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
</div>
</div>
</div>
</body></html>