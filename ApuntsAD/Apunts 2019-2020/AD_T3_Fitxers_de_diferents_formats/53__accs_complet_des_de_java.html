<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="ca" xml:lang="ca" xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" type="text/css" href="base.css" />
<link rel="stylesheet" type="text/css" href="content.css" />
<link rel="stylesheet" type="text/css" href="nav.css" />
<meta http-equiv="content-type" content="text/html;  charset=utf-8" />
<title>5.3 - Accés complet des de Java | Accés a Dades </title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<meta http-equiv="content-language" content="ca" />
<meta name="author" content="Àlvar Serrano Calduch" />
<link rel="license" type="text/html" href="http://creativecommons.org/licenses/by-nc-sa/2.5/" />
<meta name="generator" content="eXeLearning 2.7 - exelearning.net" />
<script type="text/javascript" src="exe_jquery.js"></script>
<script type="text/javascript" src="common_i18n.js"></script>
<script type="text/javascript" src="common.js"></script>
</head>
<body class="exe-web-site" id="exe-node-25"><script type="text/javascript">document.body.className+=" js"</script>
<div id="content">
<p id="skipNav"><a href="#main" class="sr-av">Omet navegació</a></p>
<div id="header" ><div id="headerContent">Accés a Dades</div></div>
<div id="siteNav">
<ul>
   <li><a href="index.html" class="daddy main-node">Tema 3: Fitxers de diferents formats</a></li>
   <li><a href="objectius.html" class="no-ch">Objectius</a></li>
   <li><a href="1_fitxers_binaris_amb_formats_especfics.html" class="no-ch">1.- Fitxers binaris amb formats específics</a></li>
   <li><a href="2_accs_directe_a_fitxers.html" class="no-ch">2.- Accés directe a fitxers</a></li>
   <li><a href="3_seriaci_dobjectes.html" class="no-ch">3.- Seriació d'objectes</a></li>
   <li><a href="4_documents_xml.html" class="daddy">4.- Documents XML</a>
   <ul class="other-section">
      <li><a href="41__parser_o_analitzador_xml.html" class="no-ch">4.1 - Parser o analitzador XML</a></li>
      <li><a href="42__lestructura_dom.html" class="daddy">4.2 - L'estructura DOM</a>
      <ul class="other-section">
         <li><a href="421_lectura.html" class="no-ch">4.2.1 Lectura</a></li>
         <li><a href="422_escriptura.html" class="no-ch">4.2.2 Escriptura</a></li>
      </ul>
      </li>
      <li><a href="43__binding.html" class="no-ch">4.3 - Binding</a></li>
   </ul>
   </li>
   <li class="current-page-parent"><a href="5_documents_json.html" class="current-page-parent daddy">5.- Documents JSON</a>
   <ul>
      <li><a href="51__estructura_json.html" class="no-ch">5.1 - Estructura JSON</a></li>
      <li><a href="52__api_simple_json.html" class="no-ch">5.2 - API Simple JSON</a></li>
      <li id="active"><a href="53__accs_complet_des_de_java.html" class="active no-ch">5.3 - Accés complet des de Java</a></li>
   </ul>
   </li>
   <li><a href="exercicis.html" class="no-ch">Exercicis</a></li>
</ul>
</div>
<div id='topPagination'>
<div class="pagination noprt">
<a href="52__api_simple_json.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="exercicis.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
<div id="main-wrapper">
<div id="main"><a name="main"></a>
<div id="nodeDecoration"><h1 id="nodeTitle">5.3 - Accés complet des de Java</h1></div>
<div class="iDevice_wrapper FreeTextIdevice" id="id110">
<div class="iDevice emphasis0">
<div id="ta110_85" class="block iDevice_content">
<p>Com ja havíem vist en els últims exemples del punt anterior, la qüestió es tracta d'anar agafant objectes i arrays, per l'estructura del JSON.</p>
<p>Mirem algun exemple ja més elaborat, on ens tocarà analitzar amb detall l'estructura json. Fem-lo sobre l'exemple de <strong>BICICAS</strong>. Podeu tornar a fer la consulta de l'estat actual en aquest moment a la pàgina <a href="http://gestiona.bicicas.es/apps/apps.php" onclick="browseURL(this); return false" target="_blank" rel="noopener noreferrer">http://gestiona.bicicas.es/apps/apps.php</a> , seleccionar-ho tot i guardar-lo en el fitxer <strong>bicicas.json</strong>. És molt possible que tinguem problemes amb els caràcers especials, com les vocals accentuades, a causa de que el navegador utilitzat no les reconega, i en copiar-les al fitxer no tinguem ja la codificació correcta. No li donarem importància en aquest moment. Recordem ací l'estructura:</p>
<p></p>
<p class="codi2" style="margin-left: 60px;">[<br />  {"ocupacion":<br />    [  {"id":"01","punto":"UJI - FCHS","puestos":28,"ocupados":11,"latitud":"39.99533","longitud":"-0.06999",<br />       "porcentajeAltaOcupacion":"80","porcentajeBajaOcupacion":"20"},<br />      {"id":"02","punto":"ESTACIÓN DE FERROCARRIL Y AUTOBUSES","puestos":28,"ocupados":8,"latitud":"39.98765",<br />       "longitud":"-0.05281","porcentajeAltaOcupacion":"80","porcentajeBajaOcupacion":"20"},<br />      {"id":"03","punto":"PLAZA DE PESCADERÍA","puestos":28,"ocupados":13,"latitud":"39.98580","longitud":"-0.03798",<br />       "porcentajeAltaOcupacion":"80","porcentajeBajaOcupacion":"20"},<br />      ...<br />    ]<br />  }<br />]</p>
<p>Com podem observar, comença per un <strong>array</strong>, no per un objecte, com sol ser habitual. L'únic que ens interessa és el <strong>primer element</strong> de l'array, ja que en posteriors anirien en tot cas missatges. El primer element és un <strong>objecte</strong> que té un únic membre <strong>ocupacion</strong> (o si en té més no ens interessen), que és un <strong>array</strong> amb totes les estacions. Cada estació és un objecte amb la informació que ens interessa.</p>
<p class="codi">import java.io.FileReader;<br />import java.io.IOException;<br /><br />import com.github.cliftonlabs.json_simple.JsonException;<br />import com.github.cliftonlabs.json_simple.Jsoner;<br />import com.github.cliftonlabs.json_simple.JsonObject;<br />import com.github.cliftonlabs.json_simple.JsonArray;<br /><br /><br />public class mirarBicicas {<br /><br />    public static void main(String[] args) throws IOException, JsonException {<br />        JsonArray arrel = (JsonArray) Jsoner.deserialize(new FileReader("bicicas.json"));<br />        JsonObject obj = (JsonObject) arrel.get(0);<br />        JsonArray estacions = (JsonArray) obj.get("ocupacion");<br /><br />        for (int i=0; i&lt;estacions.size();i++){<br />            JsonObject e = (JsonObject) estacions.get(i);<br />            System.out.println(e.get("id") + ".- " + e.get("punto") + " (" + e.get("ocupados") + "/" + e.get("puestos") + ")");<br />        }<br />    }<br />}</p>
<p>Hem utilitzat la manera habitual, meny liosa però més llarga: agafar l'array, d'ell agafar el primer objecte i d'ell agafar l'array. I hem utilitzat un bucle <strong>for</strong>, amb tantes iteracions com la grandària de l'array.</p>
<p></p>
<p class="titolet">Crear estructures JSON</p>
<p>Ens falta veure com escriure un document JSON. És molt fàcil anar creant l'estructura JSON. Només hem de recordar la manera d'afegir al <strong>JsonObject</strong> i al <strong>JsonArray</strong>.</p>
<ul>
<li><strong>put("nom", element)</strong> per afegir un nou membre a un <strong>JsonObject</strong></li>
<li><strong>add(element)</strong> per afegir un nou element a un <strong>JsonArray</strong><strong></strong></li>
</ul>
<p>Una vegada tinguem l'estructura, podrem passar-la a un <strong>string</strong> amb el mètode <strong>toJson</strong>, i la podrem guardar directament en un fitxer, per exemple.</p>
<p>Farem més d'un exemple, per poder practicar.</p>
<p>En el primer exemple generarem un JSON a partir de dades definides en el mateix programa, per mig de vectors. Intentarem generar aquest fitxer JSON:</p>
<p class="codi2" style="margin-left: 60px;">{ "empresa": <br />   { "empleat": <br />     [  {<br />           "num": "1",<br />           "nom": "Andreu",<br />           "departament": "10",<br />           "edat": "32",<br />           "sou": "1000.0"<br />        },<br />        {<br />           "num": "2",<br />           "nom": "Bernat",<br />           "departament": "20",<br />           "edat": "28",<br />           "sou": "1200.0"<br />        },<br />        {<br />           "num": "3",<br />           "nom": "Clàudia",<br />           "departament": "10",<br />           "edat": "26",<br />           "sou": "1100.0"<br />        },<br />        {<br />           "num": "4",<br />           "nom": "Damià",<br />           "departament": "10",<br />           "edat": "40",<br />           "sou": "1500.0"<br />        }<br />     ]<br />   }<br />}</p>
<p>Analitzem l'estructura. Tenim un objecte arrel, que consta d'un únic membre, empresa, que és un objecte. Aquest objecte té un únic membre que és un array. Cada element de l'array és un objecte, i els seus membres ja són clau-valor.</p>
<p class="codi">import java.io.FileWriter;<br />import java.io.IOException;<br /><br />import com.github.cliftonlabs.json_simple.JsonObject;<br />import com.github.cliftonlabs.json_simple.JsonArray;<br /><br />public class transformarEmpleats {<br /><br />    public static void main(String[] args) throws IOException {<br />        String[] noms = {"Andreu","Bernat","Clàudia","Damià"};<br />        int[] departaments = {10,20,10,10};<br />        int[] edats = {32,28,26,40};<br />        double[] sous = {1000.0,1200.0,1100.0,1500.0};<br />        <br />        JsonObject arrel = new JsonObject();<br />        JsonObject empresa = new JsonObject();<br />        arrel.put("empresa", empresa);<br />        JsonArray empleats = new JsonArray();<br />        empresa.put("empleat", empleats);<br />        <br />        for (int i=0;i&lt;4;i++){<br />            JsonObject emp = new JsonObject();<br />            emp.put("num", i+1);<br />            emp.put("nom", noms[i]);<br />            emp.put("departament", departaments[i]);<br />            emp.put("edat", edats[i]);<br />            emp.put("sou", sous[i]);<br />            empleats.add(emp);<br />        }<br />        <br />        FileWriter f = new FileWriter("Empleats.json");<br />        f.write(arrel.toJson());<br />        f.close();<br />    }<br />}</p>
<p>El resultat és el següent:</p>
<p class="codi2">{"empresa":{"empleat":[{"num":1,"sou":1000.0,"nom":"Andreu","edat":32,"departament":10},{"num":2,"sou":1200.0,"nom":"Bernat","edat":28,"departament":20},{"num":3,"sou":1100.0,"nom":"Clàudia","edat":26,"departament":10},{"num":4,"sou":1500.0,"nom":"Damià","edat":40,"departament":10}]}}</p>
<p>Per a poder-ho estudiar millor, tornem a utilitzar un <strong>visor JSON</strong> online, en aquesta ocasió un altre diferent a l'utilitzat en la pregunta 5.1.</p>
<table border="0" align="center">
<tbody>
<tr>
<td><img src="T3_5_3_1.png" height="407" width="653" /></td>
<td><img src="T3_5_3_2.png" height="405" width="651" /></td>
</tr>
</tbody>
</table>
<p>I un altre problema és que els membres de cada empleat estan <strong>desordenats</strong>. No és que haja eixit malament, perquè hem de recordar que un objecte JSON és un conjunt no ordenat de membres.</p>
<p>Si volem que apareguen ordenats, és tan senzill com substituir el <strong>JsonObject</strong> que volem que aparega ordenat per un <strong>LinkedHashMap</strong>. Aquest és el fragment de programa substituït:</p>
<p class="codi">        for (int i=0;i&lt;4;i++){<br />            Map emp = new LinkedHashMap();<br />            emp.put("num", i+1);<br />            emp.put("nom", noms[i]);<br />            emp.put("departament", departaments[i]);<br />            emp.put("edat", edats[i]);<br />            emp.put("sou", sous[i]);<br />            empleats.add(emp);<br />        }</p>
<p></p>
<p>Un altre exemple, el de <strong>Bicicas</strong>, però donant-li una altra estructura. Per tant llegirem l'original, i anirem construint la següent estructura:</p>
<p class="codi2" style="margin-left: 60px;">{ "bicicas":<br />    [ {"num":"01","nom":"UJI - FCHS","llocs":28,"ocupats":11,"lliures":17},<br />      {"num":"02","nom":"ESTACIÓN DE FERROCARRIL Y AUTOBUSES","llocs":28,"ocupats":8,"lliures":20},<br />      {"num":"03","nom":"PLAZA DE PESCADERÍA","llocs":28,"ocupats":13,"lliures":15},<br />      ...<br />    ]<br />  }<br />]</p>
<p>Per a veure més possiblitats hem utilitzat ara la manera de fer-lo en una línia, que com hem de fer cast (posar el tipus) a cada moment, queda prou engorrós en quant a parèntesis. I hem utilitzat ara el <strong>foreach</strong> per a recórrer l'array.</p>
<p>Els mètodes per a afegir són:</p>
<ul>
<li>Afegir a un objecte: <strong>put(clau,valor)</strong></li>
<li>Afegir a un array: <strong>add(valor)</strong></li>
</ul>
<p>on valor pot ser també un objecte, ...</p>
<p>Observeu sobretot la manera tan senzilla d'escriure el fitxer JSON. No cal fer cap transformació com en el cas de XML. Senzillament utilitzem el mètode de convertir JSON a string, i ho escrivim en el fitxer.</p>
<p class="codi">import java.io.FileReader;<br />import java.io.FileWriter;<br />import java.io.IOException;<br />import java.io.Reader;<br />import java.io.Writer;<br /><br />import com.github.cliftonlabs.json_simple.JsonException;<br />import com.github.cliftonlabs.json_simple.Jsoner;<br />import com.github.cliftonlabs.json_simple.JsonObject;<br />import com.github.cliftonlabs.json_simple.JsonArray;<br /><br />public class transformarBicicas {<br /><br />    public static void main(String[] args) throws IOException, JsonException {<br />        Reader r_json = new FileReader("bicicas.json");<br /><br />        JsonArray estacions = (JsonArray) ((JsonObject) ((JsonArray ) Jsoner.deserialize(r_json)).get(0)).get("ocupacion");<br />        <br />        JsonArray destEstacions = new JsonArray();<br />        <br />        for (Object est : estacions){<br />            JsonObject e = (JsonObject) est;<br />            JsonObject destE = new JsonObject();<br />            destE.put("num", e.get("id"));<br />            destE.put("nom", e.get("punto"));<br />            destE.put("llocs", e.get("puestos"));<br />            destE.put("ocupats", e.get("ocupados"));<br />            int lliures = Integer.parseInt(e.get("puestos").toString())-Integer.parseInt(e.get("ocupados").toString());<br />            destE.put("lliures", lliures );<br />            destEstacions.add(destE);<br />        }<br />        <br />        JsonObject bicicas = new JsonObject();<br />        bicicas.put("bicicas",destEstacions);<br />        <br />        Writer w_json = new FileWriter("bicicas2.json");<br />        w_json.write(bicicas.toJson());<br />        w_json.close();<br />    }<br />}</p>
<p>El resultat seria aquest (he tabulat per a una millor visualització):</p>
<p class="codi2">{"bicicas":<br />[{"num":"01","llocs":28,"ocupats":11,"lliures":17,"nom":"UJI - FCHS"},<br />{"num":"02","llocs":28,"ocupats":8,"lliures":20,"nom":"ESTACIÓN DE FERROCARRIL Y AUTOBUSES"},<br />{"num":"03","llocs":28,"ocupats":13,"lliures":15,"nom":"PLAZA DE PESCADERÍA"},<br />{"num":"04","llocs":14,"ocupats":5,"lliures":9,"nom":"PASEO BUENAVISTA-GRAO"},<br />{"num":"05","llocs":14,"ocupats":7,"lliures":7,"nom":"HOSPITAL GENERAL"},<br />...<br />]}</p>
<p>L'únic problema és que ha eixit desordenat: l'array està ordenat, però cada objecte no ha eixit amb l'ordre que havíem creat, i així el nom de cada objecte ha eixit al final.</p>
<p>Si volem que ens aparega ordenat, utilitzarem <strong>LinkedHashMap</strong>, igual que en l'exemple anterior.</p>
<p class="codi">import java.io.FileReader;<br />import java.io.FileWriter;<br />import java.io.IOException;<br />import java.io.Reader;<br />import java.io.Writer;<br />import java.util.LinkedHashMap;<br />import java.util.Map;<br /><br />import com.github.cliftonlabs.json_simple.JsonException;<br />import com.github.cliftonlabs.json_simple.Jsoner;<br />import com.github.cliftonlabs.json_simple.JsonObject;<br />import com.github.cliftonlabs.json_simple.JsonArray;<br /><br />public class transformarBicicas2 {<br /><br />    public static void main(String[] args) throws IOException, JsonException {<br />        Reader r_json = new FileReader("bicicas.json");<br /><br />        JsonArray estacions = (JsonArray) ((JsonObject) ((JsonArray ) Jsoner.deserialize(r_json)).get(0)).get("ocupacion");<br />        <br />        JsonArray destEstacions = new JsonArray();<br />        <br />        for (Object est : estacions){<br />            JsonObject e = (JsonObject) est;<br />            Map destE = new LinkedHashMap();<br />            destE.put("num", e.get("id"));<br />            destE.put("nom", e.get("punto"));<br />            destE.put("llocs", e.get("puestos"));<br />            destE.put("ocupats", e.get("ocupados"));<br />            int lliures = Integer.parseInt(e.get("puestos").toString())-Integer.parseInt(e.get("ocupados").toString());<br />            destE.put("lliures", lliures );<br />            destEstacions.add(destE);<br />        }<br />        <br />        JsonObject bicicas = new JsonObject();<br />        bicicas.put("bicicas",destEstacions);<br />        <br />        Writer w_json = new FileWriter("bicicas2.json");<br />        w_json.write(bicicas.toJson());<br />        w_json.close();<br />    }<br />}</p>
<p>Ara el resultat sí que està ordenat:</p>
<p class="codi2">{"bicicas":<br />[{"num":"01","nom":"UJI - FCHS","llocs":28,"ocupats":11,"lliures":17}<br />,{"num":"02","nom":"ESTACIÓN DE FERROCARRIL Y AUTOBUSES","llocs":28,"ocupats":8,"lliures":20},<br />{"num":"03","nom":"PLAZA DE PESCADERÍA","llocs":28,"ocupats":13,"lliures":15},<br />{"num":"04","nom":"PASEO BUENAVISTA-GRAO","llocs":14,"ocupats":5,"lliures":9},<br />{"num":"05","nom":"HOSPITAL GENERAL","llocs":14,"ocupats":7,"lliures":7},<br />...<br />]}</p>
</div>
</div>
</div>
<div id='bottomPagination'>
<div class="pagination noprt">
<a href="52__api_simple_json.html" class="prev"><span><span>&laquo; </span>Anterior</span></a> <span class="sep">| </span><a href="exercicis.html" class="next"><span>Següent<span> &raquo;</span></span></a>
</div>
</div>
<div id="packageLicense" class="cc cc-by-nc-sa">
<p><span>Llicenciat sota la </span> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.5/">Llicència Creative Commons Reconeixement NoComercial CompartirIgual 2.5</a></p>
</div>
</div>
</div>
</div>
</body></html>